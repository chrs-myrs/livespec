---
applies_to:
  - livespec_projects
criticality: IMPORTANT
failure_mode: Distribution pattern unclear causes duplication and drift between canonical and project copies
governed-by:
  - .livespec/standard/metaspecs/workspace.spec.md
derives-from:
  - specs/workspace/patterns.spec.md
---

# Distribution Pattern

## Requirements
- [!] LiveSpec distributes methodology through dist/ canonical source with multiple installation methods (sparse submodule preferred, directory copy as fallback), symlinks for framework content, and committed generated files for project-specific content.
  - **Canonical Source**:
    - dist/ contains canonical framework (source of truth)
    - dist/prompts/ - Canonical framework prompts
    - dist/templates/ - Canonical templates
    - dist/standard/ - MSL metaspecs and conventions
    - dist/guides/ - Usage guides
  - **Installation Methods** (priority order):
    - **Sparse Submodule** (preferred): Git submodule with sparse-checkout, only fetches dist/ directory, enables version pinning and auto-updates
    - **Full Submodule** (fallback): Git submodule fetching entire repository, version control without sparse optimization
    - **Directory Copy** (legacy): Manual cp command, works everywhere, no git integration
    - Helper script (scripts/install-livespec.sh) automates method detection and selection
  - **Project Integration**:
    - .livespec-repo/ - Git submodule (sparse or full, gitignored symlink target)
    - .livespec/ - Symlink to .livespec-repo/dist or copied directory (gitignored)
    - prompts/ - Symlinks to .livespec/prompts/* (no duplication)
    - prompts/generated/ - Project-specific generated prompts (committed)
  - Installation method documented in README Quick Start
  - Symlinks prevent drift between framework and project
  - Generated prompts customized to PURPOSE and specs
  - Version updates via git submodule commands or manual copy

## Distribution Structure

### Canonical Source: dist/
- **dist/prompts/** - Canonical framework prompts (source of truth)
- **dist/templates/** - Canonical templates
- **dist/standard/** - MSL metaspecs and conventions
- **dist/guides/** - Usage guides

### Project Use: Installation + Symlinks + Generated
- **.livespec-repo/** - Git submodule (if using submodule method, gitignored)
  - Sparse checkout: Only dist/ directory fetched
  - Full checkout: Entire repository fetched
  - Version control: Pinned to specific commit/tag
- **.livespec/** - Symlink to .livespec-repo/dist OR copied directory (gitignored)
  - Submodule method: Symlink to .livespec-repo/dist
  - Copy method: Direct copy of dist/ contents
- **prompts/** - Symlinks to .livespec/prompts/* (easy access, no duplication)
- **prompts/generated/** - Project-specific generated prompts (committed)
  - Generated by: prompts/utils/generate-*.md
  - Examples: self-improve.md, internalise-learnings.md
  - Customized to project PURPOSE, principles, and spec structure

## Framework Immutability

**Core principle:** .livespec/ is immutable framework reference

**Framework is read-only:**
- .livespec-repo/ contains upstream methodology (git submodule)
- .livespec/ symlinks to .livespec-repo/dist (read-only)
- Framework prompts used as-is (no modification)
- Updates via `git submodule update --remote`

**Project customization via specs/workspace/:**
- constitution.spec.md - Your development principles
- patterns.spec.md - Your coding conventions
- workflows.spec.md - Your development processes
- taxonomy.spec.md - Your domain classification

**Framework doesn't fit?**
- Rare case: Fork github.com/chrs-myrs/livespec
- Point submodule to your fork
- Normal case: Customize via specs/workspace/ (99% of projects)

**What this prevents:**
- ❌ Modification drift (framework stays canonical)
- ❌ Merge conflicts on upgrade (no customization tracking needed)
- ❌ Confusion about authoritative source (git submodule is source)

**What's preserved:**
- ✅ specs/workspace/ - Your project-specific process
- ✅ prompts/generated/ - Your generated prompts
- ✅ AGENTS.md - Your generated agent context

### Bootstrap AGENTS.md Pattern
- **dist/AGENTS.md** - Bootstrap version (minimal, ~5KB, instructs generation)
- **Project AGENTS.md** - Generated from workspace specs (30-40KB, routing)
- **Project ctxt/** - Generated sub-agent contexts (not distributed)
  - ctxt/phases/ - 5 phase specialists
  - ctxt/domains/ - Domain-specific patterns
  - ctxt/utils/ - 3 utility specialists
- **Generation**: Use `.livespec/prompts/utils/regenerate-contexts.md`
- **Timing**: Immediately after Phase 0 (workspace specs established)

**Bootstrap AGENTS.md content**:
- No frontmatter (clean agent context)
- Inline edit warning
- Summary of bootstrap purpose
- Instructions to regenerate full context tree
- Minimal essential rules (spec-first, MSL format)
- Path to Phase 0 for new projects

**Generated AGENTS.md + ctxt/ content**:
- Customized to project PURPOSE, domain, constraints
- Root AGENTS.md: Routing to specialized sub-agents
- Sub-agents: Phase/domain/utility specialists with proactive loading
- Total tree <150KB, typical loaded <60KB

## Installation Method Benefits

### Sparse Submodule (Recommended)

**Benefits:**
- Only fetches dist/ directory (minimal bandwidth/disk)
- Version control via git (pin to tags/commits)
- Auto-update via `git submodule update --remote`
- No duplication across projects
- Single source of truth (.livespec → .livespec-repo/dist → remote)

**Trade-offs:**
- Requires git 2.25+ or git-partial-submodule tool
- Slightly more complex initial setup
- Symlink needed for .livespec path

### Directory Copy (Simple)

**Benefits:**
- Works in all environments (no git version requirements)
- Simple conceptual model (just files)
- No external dependencies

**Trade-offs:**
- Manual update process
- Duplication across projects
- No version control integration
- Risk of local modifications

### Symlink Architecture

**Pattern:**
```bash
.livespec-repo/          # Git submodule
  └── dist/              # Only this fetched with sparse checkout
.livespec -> .livespec-repo/dist  # Symlink for consistent path
prompts/0-define/ -> ../.livespec/prompts/0-define/
prompts/1-design/ -> ../.livespec/prompts/1-design/
prompts/generated/       # Real directory with project-specific content
```

**Benefits:**
- Single source of truth (dist/ is canonical)
- No drift between prompts/ and .livespec/prompts/
- Updates propagate through symlink chain
- Clear separation: framework (symlinked) vs project-specific (generated/)

## Why Generated Prompts Are Committed

**Rationale:**
- Tailored to specific project context
- Reference actual PURPOSE.md and specs/
- Should be versioned with project
- Regenerated when project fundamentals change

**Examples:**
- prompts/generated/self-improve.md - Project-specific improvement analysis
- prompts/generated/internalise-learnings.md - Captures learnings in project specs

## Template Architecture Pattern

**Purpose:** Reusable markdown content for consistent agent guidance

**When to Create Template:**
- Content reused across multiple generated files
- Key process/checklist needing consistent application
- Content requiring independent updates without prompt changes

**Template Structure:**
- **Location**: `.livespec/templates/{domain}/` (e.g., `agents/`, `workspace/`)
- **Format**: Complete standalone markdown (not fragment)
- **Naming**: Descriptive (e.g., `pre-implementation-verification.md`)

**Template Flow:**
1. **Templates provide** reusable content (`.livespec/templates/agents/*.md`)
2. **Specs reference** templates (e.g., "Include `.livespec/templates/agents/X.md`")
3. **Prompts insert** templates during generation (e.g., "Insert template in START section")
4. **Generated files** are products (e.g., AGENTS.md includes template content)
5. **Distribution** via `dist/templates/` (target projects receive templates)

**Example:** Agent verification templates
- `templates/agents/pre-implementation-verification.md` - Checklist before implementing
- Referenced by: `specs/workspace/workspace-agent.spec.md`
- Inserted by: `prompts/4-evolve/4d-regenerate-context.md`
- Result: AGENTS.md includes verification in START section

**Benefits:**
- Explicit and manageable (not embedded in prompts)
- Independently updatable (change template, regenerate)
- Distributable (templates copy to target projects)

## Reference Library Pattern

**Purpose**: Enable agents to navigate from AGENTS.md summary (80%) to deep detail (20%)

**Path convention**: Always use `.livespec/` prefix
- Works in livespec repo (`.livespec` → symlink to `dist/`)
- Works in target projects (`.livespec/` copied from `dist/`)
- Consistent across all environments

**Structure**:
- **Categories**: Conventions (how to structure), Metaspecs (spec types), Guides (how to apply)
- **Entry format**:
  - **Fetch when**: Action-oriented trigger conditions
  - **Provides**: What detail this reference contains
  - **Cross-ref**: Where in AGENTS.md this topic is summarized

**Example**:
```markdown
**Context Compression** - `.livespec/standard/conventions/context-compression.spec.md`
- **Fetch when**: Deciding inline vs extract, optimizing AGENTS.md size
- **Provides**: Full compression framework, decision criteria, extraction patterns
- **Cross-ref**: See "Context Compression" section for summary
```

**Location**: MIDDLE or END section of AGENTS.md (detailed navigation, not critical rules)

**Integration**: Cross-reference from AGENTS.md summary sections
```markdown
## Context Compression
[Brief summary]

**Framework reference**: See Reference Library: `context-compression.spec.md`
```

**Validation**:
- All `.livespec/` paths work in both livespec repo and target projects
- "Fetch when" conditions are action-oriented (not passive descriptions)
- Cross-references bidirectional (AGENTS.md ↔ Reference Library)
- Categories logical (Conventions, Metaspecs, Guides)

## Validation
- dist/ contains canonical framework source
- dist/AGENTS.md is bootstrap version (~5KB, instructs generation)
- Installation methods documented in README and specs/3-behaviors/installation.spec.md
- Helper script (scripts/install-livespec.sh) exists and is executable
- Sparse submodule method only fetches dist/ directory
- .livespec-repo/ created as git submodule (when using submodule method)
- .livespec/ is symlink to .livespec-repo/dist OR copied directory
- prompts/ uses symlinks to .livespec/prompts/* (no duplication)
- prompts/generated/ contains project-specific content
- Generated prompts committed to version control
- .livespec/ and .livespec-repo/ gitignored in target projects
- Project AGENTS.md generated from workspace specs (after Phase 0)
- Project ctxt/ generated alongside AGENTS.md (not distributed)
- Templates follow structure and naming conventions
- Reference Library uses `.livespec/` prefix consistently
- No drift between framework and project copies
